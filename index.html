<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Message Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .recipient-name { font-size: 18px; font-weight: 500; color: #333; }
        .search-icon { width: 24px; height: 24px; cursor: pointer; color: #666; }
        .search-bar { padding: 10px 20px; background: white; border-bottom: 1px solid #e0e0e0; display: none; }
        .search-bar.active { display: block; }
        .search-input {
            width: 100%; padding: 10px 15px; border: 1px solid #ddd;
            border-radius: 20px; font-size: 16px; outline: none;
        }
        .search-input:focus { border-color: #007aff; }
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .message { display: flex; margin-bottom: 5px; }
        .message.sent { justify-content: flex-end; }
        .message.received { justify-content: flex-start; }
        .message-bubble {
            max-width: 70%; padding: 12px 16px; border-radius: 18px;
            font-size: 16px; line-height: 1.4; word-wrap: break-word;
            position: relative;
        }
        .message.sent .message-bubble { background: #007aff; color: white; }
        .message.received .message-bubble { background: #e5e5ea; color: #000; }
        .message-time { font-size: 12px; color: #666; margin-top: 5px; margin-bottom: 10px; text-align: right; }
        .message.received .message-time { text-align: left; }
        .highlight { background-color: #ffeb3b; color: #000; padding: 1px 2px; border-radius: 2px; font-weight: 500; }
        .current-match { background-color: #ff9800; color: white; }
        .sender-name { font-size: 12px; color: #666; margin-bottom: 5px; padding-left: 16px; }
        .upload-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .upload-box {
            background: white; border-radius: 20px; padding: 40px; text-align: center;
            max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .upload-area {
            border: 3px dashed #ccc; border-radius: 15px; padding: 40px 20px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover { border-color: #007aff; background: #f0f8ff; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { font-size: 18px; color: #333; margin-bottom: 10px; }
        .upload-hint { color: #666; font-size: 14px; }
        .file-input { display: none; }
        .no-messages { text-align: center; color: #666; font-size: 16px; margin-top: 100px; }
        .loading { text-align: center; color: #666; padding: 40px; }
        .spinner {
            border: 3px solid #f3f4f6; border-top: 3px solid #007aff; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .message-bubble { max-width: 85%; } }
        .search-navigation { display: none; padding: 10px 20px; background: white; border-bottom: 1px solid #e0e0e0; align-items: center; justify-content: space-between; }
        .search-navigation.active { display: flex; }
        .search-results-info { font-size: 14px; color: #666; }
        .search-nav-buttons { display: flex; gap: 10px; }
        .nav-button {
            width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #666;
        }
        .nav-button:hover { background: #f0f0f0; }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .nav-button:disabled:hover { background: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="recipient-name" id="recipientName">Chat Viewer</div>
        <svg class="search-icon" id="searchIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
        </svg>
    </div>

    <div class="search-bar" id="searchBar">
        <input type="text" class="search-input" id="searchInput" placeholder="Search messages...">
    </div>

    <div class="search-navigation" id="searchNavigation">
        <div class="search-results-info" id="searchResultsInfo">0 matches</div>
        <div class="search-nav-buttons">
            <button class="nav-button" id="prevButton" disabled>‚Üë</button>
            <button class="nav-button" id="nextButton" disabled>‚Üì</button>
        </div>
    </div>

    <div class="chat-area" id="chatArea">
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <div>Loading messages...</div>
        </div>
    </div>

    <div class="upload-overlay" id="uploadOverlay">
        <div class="upload-box">
            <div class="upload-area" id="uploadArea">
                <input type="file" class="file-input" id="fileInput" accept=".json" multiple>
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your files</div>
                <div class="upload-hint">Select JSON chat export files</div>
            </div>
        </div>
    </div>

    <script>
        class ChatViewer {
            constructor() {
                this.chatData = [];
                this.allMessages = [];
                this.filteredMessages = [];
                this.participants = new Set();
                this.currentUser = 'geets';
                this.searchMatches = [];
                this.currentMatchIndex = -1;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const searchIcon = document.getElementById('searchIcon');
                const searchBar = document.getElementById('searchBar');
                const searchInput = document.getElementById('searchInput');

                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));

                searchIcon.addEventListener('click', () => {
                    searchBar.classList.toggle('active');
                    if (searchBar.classList.contains('active')) searchInput.focus();
                    else { searchInput.value = ''; this.handleSearch(); }
                });

                searchInput.addEventListener('input', this.debounce(this.handleSearch.bind(this), 300));

                document.getElementById('prevButton').addEventListener('click', this.goToPreviousMatch.bind(this));
                document.getElementById('nextButton').addEventListener('click', this.goToNextMatch.bind(this));
            }

            handleDragOver(e) { e.preventDefault(); document.getElementById('uploadArea').classList.add('dragover'); }
            handleDragLeave(e) { e.preventDefault(); document.getElementById('uploadArea').classList.remove('dragover'); }
            handleDrop(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/json');
                this.processFiles(files);
            }
            handleFileSelect(e) { this.processFiles(Array.from(e.target.files)); }

            async processFiles(files) {
                if (files.length === 0) return;
                this.showLoading(true);
                this.hideUploadOverlay();
                this.chatData = [];
                this.allMessages = [];
                this.participants.clear();

                try {
                    for (const file of files) {
                        const content = await this.readFile(file);
                        const thread = this.parseAndConvertChatData(content, file.name);
                        if (thread) { this.chatData.push(thread); this.extractMessages(thread); }
                    }
                    this.filteredMessages = [...this.allMessages];
                    this.renderMessages();
                    this.updateRecipientName();
                } catch (error) { this.showError('Error processing files: ' + error.message); }
                finally { this.showLoading(false); }
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }

            parseAndConvertChatData(jsonString, filename) {
                const data = JSON.parse(jsonString);
                if (data.participants) data.participants.forEach(p => this.participants.add(p.name));
                data.filename = filename;
                return data;
            }

            extractMessages(thread) {
                if (!thread.messages) return;
                thread.messages.forEach(msg => this.allMessages.push({...msg, threadTitle: thread.title, threadFilename: thread.filename}));
                this.allMessages.sort((a,b) => (a.timestamp_ms||0) - (b.timestamp_ms||0));
            }

            handleSearch() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                const nav = document.getElementById('searchNavigation');
                if (!searchTerm) {
                    this.filteredMessages = [...this.allMessages];
                    this.searchMatches = [];
                    this.currentMatchIndex = -1;
                    nav.classList.remove('active');
                } else {
                    this.filteredMessages = this.allMessages.filter(msg => msg.content?.toLowerCase().includes(searchTerm) || msg.sender_name?.toLowerCase().includes(searchTerm));
                    this.findSearchMatches(searchTerm);
                    nav.classList.add('active');
                }
                this.renderMessages();
                this.updateSearchNavigation();
            }

            findSearchMatches(searchTerm) {
                this.searchMatches = [];
                this.filteredMessages.forEach((msg,i) => {
                    const content = msg.content?.toLowerCase()||'', sender = msg.sender_name?.toLowerCase()||'';
                    if (content.includes(searchTerm) || sender.includes(searchTerm)) this.searchMatches.push(i);
                });
                this.currentMatchIndex = this.searchMatches.length ? 0 : -1;
            }

            goToPreviousMatch() {
                if (!this.searchMatches.length) return;
                this.currentMatchIndex = this.currentMatchIndex<=0 ? this.searchMatches.length-1 : this.currentMatchIndex-1;
                this.updateSearchNavigation();
                this.scrollToCurrentMatch();
            }
            goToNextMatch() {
                if (!this.searchMatches.length) return;
                this.currentMatchIndex = this.currentMatchIndex>=this.searchMatches.length-1 ? 0 : this.currentMatchIndex+1;
                this.updateSearchNavigation();
                this.scrollToCurrentMatch();
            }

            updateSearchNavigation() {
                const resultsInfo = document.getElementById('searchResultsInfo');
                const prevButton = document.getElementById('prevButton');
                const nextButton = document.getElementById('nextButton');
                if (!this.searchMatches.length) {
                    resultsInfo.textContent = 'No matches'; prevButton.disabled = true; nextButton.disabled = true;
                } else {
                    resultsInfo.textContent = `${this.currentMatchIndex+1} of ${this.searchMatches.length}`;
                    prevButton.disabled = false; nextButton.disabled = false;
                }
                this.renderMessages();
            }

            scrollToCurrentMatch() {
                setTimeout(() => {
                    const el = document.querySelector('.current-match');
                    if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
                }, 100);
            }

            renderMessages() {
                const chatArea = document.getElementById('chatArea');
                if (!this.filteredMessages.length) { chatArea.innerHTML = '<div class="no-messages">No messages to display</div>'; return; }
                let html = '';
                this.filteredMessages.forEach((msg,i) => {
                    const isSent = msg.sender_name===this.currentUser;
                    const showSender = !isSent && this.shouldShowSender(i);
                    html += this.renderMessage(msg,isSent,showSender,i);
                });
                chatArea.innerHTML = html;
                if (this.currentMatchIndex!==-1) this.scrollToCurrentMatch();
                else this.scrollToBottom();
            }

            shouldShowSender(index) {
                if (index===0) return true;
                return this.filteredMessages[index].sender_name !== this.filteredMessages[index-1].sender_name;
            }

            renderMessage(message, isSent, showSender, messageIndex) {
                const time = message.timestamp_ms ? new Date(message.timestamp_ms).toLocaleDateString('en-US', { month:'short', day:'numeric'}) : '';
                const senderHtml = showSender && !isSent ? `<div class="sender-name">${message.sender_name||'Unknown'}</div>` : '';
                let content = message.content || '[No content]';
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                if (searchTerm) {
                    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
                    content = content.replace(regex, match => {
                        const isCurrent = this.currentMatchIndex!==-1 && this.searchMatches[this.currentMatchIndex]===messageIndex;
                        const highlightClass = isCurrent ? 'current-match':'highlight';
                        return `<span class="${highlightClass}">${match}</span>`;
                    });
                }
                return `
                    <div>
                        ${senderHtml}
                        <div class="message ${isSent?'sent':'received'}">
                            <div class="message-bubble">${content}</div>
                        </div>
                        ${time?`<div class="message-time">${time}</div>`:''}
                    </div>
                `;
            }

            updateRecipientName() {
                const recipientName = document.getElementById('recipientName');
                if (this.chatData.length===1) recipientName.textContent = this.chatData[0].title||'Chat';
                else if (this.chatData.length>1) recipientName.textContent = `${this.chatData.length} Conversations`;
                else recipientName.textContent = 'Chat Viewer';
            }

            scrollToBottom() { document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight; }
            hideUploadOverlay() { document.getElementById('uploadOverlay').style.display='none'; }
            showLoading(show) { document.getElementById('loading').style.display = show?'block':'none'; }
            showError(msg) { document.getElementById('chatArea').innerHTML=`<div style="text-align:center;color:#ff3b30;padding:40px;"><div style="font-size:48px;margin-bottom:15px;">‚ö†Ô∏è</div><div>${msg}</div></div>`; }
            debounce(func,wait){let timeout; return function(...args){const later=()=>{clearTimeout(timeout);func(...args)};clearTimeout(timeout);timeout=setTimeout(later,wait);};}
        }

        new ChatViewer();
    </script>
</body>
</html>
